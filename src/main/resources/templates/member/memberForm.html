<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.w3.org/1999/xhtml">
<head>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <div layout:fragment="content">
        <th:block layout:fragment="script">
            <script th:inline="javascript">
                $(document).ready(function(){
                    var errorMessage = [[${errorMessage}]];

                    if(errorMessage != null){
                        alert(errorMessage);
                    }
                });

                function mailSend(){
                    var token = $("meta[name='_csrf']").attr("content");
                    var header = $("meta[name='_csrf_header']").attr("content");
                    var mail = $("#sendmail").val();
                    var url = "/members/" + mail +"/emailConfirm";
                    var paramData = { email: mail };
                    var param = JSON.stringify(paramData);

                    $.ajax({
                        url      : url,
                        type     : "POST",
                        contentType : "application/json",
                        data     : param,
                        beforeSend : function(xhr){
                            console.log("2")
                            xhr.setRequestHeader(header, token);
                        },
                        dataType : "json",
                        cache   : false,
                        success  : function(result, status){
                            console.log("3")
                            alert(result);
                        },
                        error : function(jqXHR, status, error){
                            if(jqXHR.status == '401'){
                                console.log("4")
                                location.href='/members/login';
                            } else{
                                console.log("5")
                                alert(jqXHR.responseText);
                            }
                        }
                    });
                }

                function codeCheck(){
                    var token = $("meta[name='_csrf']").attr("content");
                    var header = $("meta[name='_csrf_header']").attr("content");
                    var code = $("#codecheck").val();
                    var url = "/members/" + code +"/codeCheck";
                    var paramData = { code: code };
                    var param = JSON.stringify(paramData);

                    $.ajax({
                        url      : url,
                        type     : "POST",
                        contentType : "application/json",
                        data     : param,
                        beforeSend : function(xhr){
                            xhr.setRequestHeader(header, token);
                        },
                        dataType : "json",
                        cache   : false,
                        success  : function(result, status){
                            alert(result);
                        },
                        error : function(jqXHR, status, error){
                            if(jqXHR.status == '401'){
                                location.href='/members/new';
                            } else{
                                alert(jqXHR.responseText);
                            }
                        }
                    });
                }

                function daumPost(){
                    new daum.Postcode({
                        oncomplete: function(data) {
                            // 팝업에서 검색결과 항목을 클릭했을때 실행할 코드를 작성하는 부분입니다.
                            // 예제를 참고하여 다양한 활용법을 확인해 보세요.

                            // 사용자가 선택한 주소 타입에 따라 해당 주소 값을 가져온다.
                            var addr = data.userSelectedType === 'R' ? data.roadAddress : data.jibunAddress;
                            document.getElementById('postcode').value = data.zonecode;
                            document.getElementById('address').value = addr;
                            document.getElementById('detailAddress').focus();
                        }
                    }).open();
                }

                $('#send').click(function() {
                    var to = $('#to').val();
                });

                function sendVerificationCode() {
                console.log("123")
                    var phoneNumber = document.getElementById('tel').value;
                    var telError = document.getElementById('telError');
                    if (!phoneNumber) {
                    console.log("222")
                        telError.style.display = 'block';
                        console.log("333")
                        return;
                    } else {
                    console.log("444")
                        telError.style.display = 'none';
                    }

                    // CSRF 토큰 가져오기 (만약 Spring Security를 사용하고 있다면)
                    var csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                    var csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

                    $.ajax({
                        url: '/verification/sendVerificationCode',
                        type: 'POST',
                        data: { phoneNumber: phoneNumber },
                        beforeSend: function(xhr) {
                            xhr.setRequestHeader(csrfHeader, csrfToken);
                        },
                        success: function(response) {
                            alert(response); // 서버에서 오는 메시지 ("인증번호가 전송되었습니다.")
                        },
                        error: function(error) {
                            console.log(error);
                            alert('인증번호 전송에 실패했습니다.');
                        }
                    });
                }

                function verifyCode() {
                    var phoneNumber = document.getElementById('tel').value;
                    var verificationCode = document.getElementById('verificationCode').value;

                    // CSRF 토큰 가져오기 (만약 Spring Security를 사용하고 있다면)
                    var csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                    var csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

                    $.ajax({
                        url: '/verification/verifyCode',
                        type: 'POST',
                        data: {
                            phoneNumber: phoneNumber,
                            verificationCode: verificationCode
                        },
                        beforeSend: function(xhr) {
                            xhr.setRequestHeader(csrfHeader, csrfToken);
                        },
                        success: function(response) {
                            document.getElementById('verificationMessage').innerText = response; // 서버에서 오는 메시지 ("확인되셨습니다." 또는 "올바른 인증번호를 입력 해 주세요.")
                        },
                        error: function(error) {
                            console.log(error);
                            alert('인증번호 확인에 실패했습니다.');
                        }
                    });
                }
            </script>
        </th:block>
    </div>
</head>
<body>
    <form action="/member/new" role="form" method="post" th:object="${memberFormDto}">
        <div class="form-group">
            <label th:for="name">이름 입력</label>
            <input type="text" th:field="*{name}" placeholder="이름 입력">
        </div>
        <p th:if="${#fields.hasErrors('name')}" th:errors="*{name}" class="fieldError"></p>
        <div class="form-group">
            <label th:for="email">이메일 주소</label>
            <input type="text" th:field="*{email}" id="sendmail" placeholder="이메일 입력">
            <button class="btn" id="e_2" onclick="mailSend()" type="button">인증 메일 발송</button>
            <input class="form-control" id="codecheck" placeholder="인증 코드 입력" type="text">
            <button class="btn" id="c_2" onclick="codeCheck()" type="button">인증 코드 확인</button>
        </div>
        <p th:if="${#fields.hasErrors('email')}" th:errors="*{email}" class="fieldError"></p>
        <div class="form-group">
            <label th:for="password">비밀번호</label>
            <input type="password" th:field="*{password}" placeholder="비밀번호 입력">
        </div>
        <p th:if="${#fields.hasErrors('password')}" th:errors="*{password}" class="fieldError"></p>
        <div class="form-group">
            <label th:for="address">주소</label>

            <input type="text" id="postcode" th:field="*{postcode}" placeholder="" readonly="readonly">
            <input type="button" onclick="daumPost()" value="우편번호 찾기">
            <input type="text" id="detailAddress" th:field="*{detailAddress}" placeholder="상세주소 입력">
            <input type="text" id="address" th:field="*{address}"><br>
        </div>
        <p th:if="${#fields.hasErrors('address')}" th:errors="*{address}" class="fieldError"></p>
        <div class="form-group">
            <label th:for="tel">전화번호</label>
            <input id="tel" placeholder="010 1234 1234" th:field="*{tel}" type="text">
            <!-------------------------------전화 인증----------------------------------------->
            <button id="col" onclick="sendVerificationCode()" type="button">인증번호 발송</button>
            <input id="verificationCode" placeholder="인증번호 입력" type="text">
            <button id="colcol" onclick="verifyCode()" type="button">인증 번호 확인</button>
            <p id="verificationMessage"></p>
        </div>


        <p id="telError" class="fieldError" style="display:none;">전화번호를 입력해주세요.</p>
        <p th:if="${#fields.hasErrors('tel')}" th:errors="*{tel}" class="fieldError" ></p>

        <div style="text-align: center">
            <button type="submit" class="btn btn-primary">가입완료</button>
        </div>

        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
    </form>
</body>
</html>